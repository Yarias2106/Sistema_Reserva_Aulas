{% extends 'BaseHeaderFooter.html' %}

 {% block title %}
     Vista Docente
 {% endblock %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static '/css/FormularioReserva.css' %}">

<section class="BodyFont mx-4">
    <div class="container formReserva col-md-6">
        <div class="row px-4">
            <h4 class="text-center text-white pt-3 col-12">Parametrización</h4>
            <center>
              <div id="ventana">
                <!-- Aqui van los mensajes -->
              </div>
            </center>
            <h6 class="text-white col-12 pt-2">Rango de fechas límite de reserva de ambiente</h6>
        </div>
        <!-- <form action="/ConfigurarParametros/" method="POST" class="row g-3 p-4"> -->
        <div class="row g-3 p-4">
        {% csrf_token %} 

            <div class="col-lg-6 col-md-12 col-sm-12 col-12" style="display: flex; align-items: center;">
            <label for="input-label" class="form-label text-white me-3">Mínimo de reserva (días) </label>
            <input type="number" name="min" id="min" class="form-control" value="{{rango.Minimo}}" min="1" style="width:4rem;" required>
            </div>
    
            <div class="col-lg-6 col-md-12 col-sm-12 col-12" style="display: flex; align-items: center;">
            <label for="inputState" class="form-label text-white me-3">Máximo de reserva (días) </label>
            <input type="number" name="max" id="max" class="form-control" value="{{rango.Maximo}}" min="1" style="width:4rem;" required>
            </div>

            <div class="">
              <label for="validationTextarea" class="form-label text-white">Motivo:</label>
              <textarea class="form-control" placeholder="Describa el motivo del cambio de configuración" id="Motivo" name="Motivo"></textarea>
              <div class="invalid-feedback">
              </div>
            </div>

            <div class="col-12">
            <center><input type="submit" class="btn btn-primary" value="Guardar" onclick="guardar()"></input></center>
            <!-- <center><button type="button" id="liminar" class="btn btn-primary" onclick="guardar()">Guardar</button></center> Hola -->
            </div>
         </div>
         <table id="myTable" class="table table-light mb-5" style="max-width:70%; margin: auto;">
          <thead class="table-secondary">
              <tr>
                <th onclick="sortTable(0, 'int')" scope="col" class="hoverTitulo" id="iconRow" style="cursor: pointer;"># <i id="icon" class="bi bi-arrow-down"></i></th>
                <th onclick="sortTable(1, 'str')" scope="col" class="hoverTitulo" id="iconRow1" style="cursor: pointer;">Mínimo <i id="icon1" class="bi bi-arrow-down"></i></th>
                <th onclick="sortTable(2, 'str')" scope="col" class="hoverTitulo" id="iconRow2" style="cursor: pointer;">Máximo <i id="icon2" class="bi bi-arrow-down"></i></th>
                <th onclick="sortTable(3, 'int')" scope="col" class="text-center hoverTitulo" id="iconRow3" style="cursor: pointer;">Fecha <i id="icon3" class="bi bi-arrow-down"></i></th>
                <th scope="col" class="col-sm-1">Motivo</th>
              </tr>
            </thead>
            <tbody id="Lista">
                {% for tupla in logs %}
                <tr>
                  <td scope="row" style="font-weight: bold;">{{ forloop.counter }}</td>
                  <td>{{tupla.Minimo}}</td>
                  <td class="text-center">{{tupla.Maximo}}</td>
                  <td class="text-center">{{tupla.FechaModificacion}}</td>
                  <td><button class="bi bi-pencil-square iconEdit " data-toggle="modal" data-target="#modalAmbientes" onclick="setMotivo('{{tupla.Motivo}}')"></button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- MODAL ! -->
<div class="modal fade px-5" id="modalAmbientes" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered " role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" >Motivo</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="mb-3 row">
          <div class="row g-3">
            <textarea name="AreaMotivo" id="AreaMotivo" cols="30" rows="10"></textarea>
          </div>
        </div>
      </div>

      <div class="modal-footer justify-content-center">
        <button type="button" id="cancelar" class="btn btn-secondary col-4" data-dismiss="modal" >Cancelar</button>
        <button type="button" class="btn btn-primary col-4" data-dismiss="modal" onclick="guardarCambios()">Guardar</button>
      </div>

    </div>
  </div>
</div>
  </section>
{% endblock %}  

{% block scripts %}
<script>
    function guardar(){
    let minimo = parseInt(document.getElementById('min').value);
    let maximo = parseInt(document.getElementById('max').value);
    let motivoCambio = document.getElementById('Motivo').value;
    //console.log(motivo)
    if(minimo < 1){
      crearMensaje("El valor del rango mínimo no puede ser menor a 1");
    }
    if(maximo < 1){
      crearMensaje("El valor del rango máximo no puede ser menor a 1");
    }
    if(minimo > maximo){
      crearMensaje("El valor del rango mínimo no puede ser mayor al rango máximo");
    }
    if(minimo === maximo){
      crearMensaje("El valor del rango mínimo y máximo no pueden ser iguales");
    }
    if(!motivoCambio){
      crearMensaje("Debe ingresar el motivo de la configuración");
    }
    if((minimo >= 1) && (minimo < maximo) && motivoCambio){
        console.log("si esta entrando")
        let rutaActual = location.href
        console.log(rutaActual)
        let ruta = rutaActual.replace("ConfigurarParametros/", "VistaAdmin/");
        console.log(ruta)
        
        console.log(motivoCambio)
        //console.log(`este es el max ${maximo} y el min: ${minimo}`)
          Swal.fire({
          title: '¿Está seguro de guardar los cambios?',
          //text: "You won't be able to revert this!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          cancelButtonText: 'Cancelar',
          confirmButtonText: 'Aceptar'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
            type: "GET",
            url: '/ConfigurarParametros',
            data: {
                'min' : minimo,
                'max' : maximo,
                'Motivo' : motivoCambio
              },
            });
            Swal.fire({
            title: '¡Datos guardados exitosamente!',
            icon: 'success',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ok'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.href = ruta
                }
            })
          }
        })
    };
};
function crearMensaje(mensaje){
    let ventana = document.getElementById('ventana');
    ventana.innerHTML = `<div id="VentanaHijo" class="alert alert-danger alert-dismissible fade show alertaCol"     role="alert">${mensaje}</div>`;
    setTimeout(() => {
          document.getElementById('VentanaHijo').remove();
    },4000);         
};
</script>
<script>
  function setMotivo(mot){
      elMotivo = mot;
      document.getElementById('AreaMotivo').textContent = elMotivo;
    };
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
{% endblock %}